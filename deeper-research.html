<!doctype html>

<html>
    <head>
        <title>Prompt Generation</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            background: "#ffffff",
                            foreground: "#030213",
                            card: "#ffffff",
                            "card-foreground": "#030213",
                            primary: "#030213",
                            "primary-foreground": "#ffffff",
                            secondary: "#f3f3f5",
                            "secondary-foreground": "#030213",
                            muted: "#ececf0",
                            "muted-foreground": "#717182",
                            border: "rgba(0, 0, 0, 0.1)",
                            "input-background": "#f3f3f5",
                        },
                    },
                },
            };
        </script>
        <script>
            const OPENAI_URL = "http://192.168.0.90:1234/v1/chat/completions";
            const LM_STUDIO_MODEL = "google/gemma-3n-e4b";
            const MAX_RETRIES = 100;
            const INITIAL_BACKOFF = 60010; // in milliseconds
            const EXCLUDED_DOMAINS = [
                "en.wikipedia.org",
                "simple.wikipedia.org",
                "wikipedia.org",
                "linkedin.com",
                "quora.com",
                "reddit.com",
                "acm.org",
                "dl.acm.org",
                "journals.sagepub.com",
                "link.springer.com",
                "springer.com",
                "sciencedirect.com",
                "jstor.org",
                "academia.edu",
            ];

            let prompts = [];
            let urls = [];
            let finalUrls = [];
            let currentUrlIndex = 0;

            async function fetchAndDisplayPrompts(topic) {
                const promptDiv = document.getElementById(
                    "prompt-generation-container",
                );

                promptDiv.innerHTML =
                    '<p class="text-muted-foreground">Loading...</p>';

                prompts = await fetchPrompts(topic);

                promptDiv.innerHTML = generatePromptComponentList(prompts);
            }

            async function fetchPrompts(topic) {
                const userPrompt = `I'm a college professor writing research report on ${topic} and need help coming up with diverse search queries. Please generate 5-15 search queries that would be useful for use with a search engine like Google. Each query should be 5-10 words. Output using the JSON schema provided.`;

                const systemPrompt =
                    "You are a graduate assistant for a Professor at a prestigious US university. The user will ask you to help generate a search query. Respond with 5-15 search queries. Each query should be a string in a list, returned as a JSON array.";

                response_schema = {
                    type: "json_schema",
                    json_schema: {
                        name: "prompt_array",
                        schema: {
                            type: "array",
                            items: {
                                type: "string",
                                minLength: 1,
                                maxLength: 100,
                            },
                        },
                    },
                };

                const response = await fetch(OPENAI_URL, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: `Bearer fake`,
                    },
                    body: JSON.stringify({
                        model: LM_STUDIO_MODEL,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt },
                        ],
                        response_format: response_schema,
                    }),
                });

                if (!response.ok) {
                    throw new Error(`Error: ${response.statusText}`);
                }

                const completion = await response.json();

                const promptResults = JSON.parse(
                    completion.choices[0].message.content,
                );

                return promptResults;
            }

            function addPrompt(prompt) {
                if (!prompt) return;

                const promptDiv = document.getElementById(
                    "prompt-generation-container",
                );

                prompts.push(prompt);

                promptDiv.innerHTML = generatePromptComponentList(prompts);
            }

            function removePrompt(sanitizedPrompt) {
                const promptDiv = document.getElementById(
                    "prompt-generation-container",
                );

                prompts = prompts.filter(
                    (p) => sanitizePrompt(p) !== sanitizedPrompt,
                );

                promptDiv.innerHTML = generatePromptComponentList(prompts);
            }

            function generatePromptComponentList(prompts) {
                return `<ul class="space-y-2">${prompts.map((prompt) => generatePromptComponent(prompt)).join("\n")}<li class="flex gap-2 pt-2 border-t border-border"><input id="add-prompt-input" type="text" placeholder="Enter prompt" class="flex-1 px-3 py-2 bg-input-background border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20"/><button onclick="addPrompt(document.getElementById('add-prompt-input').value)" class="px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors">Add</button></li></ul>`;
            }

            function generatePromptComponent(prompt) {
                const sanitizedPrompt = sanitizePrompt(prompt);
                const userVisiblePrompt = cleanPromptForUser(prompt);

                return `<li id="${sanitizedPrompt}" class="flex items-center justify-between p-3 bg-card border border-border rounded-lg"><span class="text-foreground">${userVisiblePrompt}</span><button onclick="removePrompt('${sanitizedPrompt}')" class="px-3 py-1 text-sm bg-secondary text-secondary-foreground rounded hover:bg-secondary/80 transition-colors">Remove</button></li>`;
            }

            function cleanPromptForUser(prompt) {
                // google/gemma-3n-e4b tries to do weird things with the prompt
                try {
                    const parsedPrompt = JSON.parse(prompt);
                    const userVisiblePrompt = parsedPrompt?.query;
                    return userVisiblePrompt;
                } catch (error) {
                    console.error(
                        "Error parsing prompt, continuing to try trimming",
                        error,
                    );
                }

                // liquid/lfm2-1.2b tries to do different weird things with the prompt
                const trimmedPrompt = prompt.trim();

                const splitString = trimmedPrompt.split("-").join(" ");

                return splitString.replace(/^\/+/, "").replace(/\/+$/, ""); // replace slashes with nothing
            }

            function sanitizePrompt(str) {
                return (
                    str
                        // Convert to lowercase (optional)
                        .toLowerCase()
                        // Replace invalid characters with hyphens
                        .replace(/[^a-z0-9\-_\.]/g, "-")
                        // Ensure it doesn't start with a digit
                        .replace(/^[0-9]/, "")
                        // Remove multiple hyphens
                        .replace(/-+/g, "-")
                        // Trim hyphens from start and end
                        .replace(/^-|-$/g, "")
                );
            }

            async function findAndDisplaySearchResults() {
                const searchResultsDiv =
                    document.getElementById("search-results");

                searchResultsDiv.innerHTML = `
                   <p class="text-muted-foreground">Finding search results...</p>
               `;

                for (const prompt of prompts) {
                    const urlsFromSearchResults = await searchForPrompt(prompt);

                    console.log("urls before filtering: ", urls.length);

                    const urlsWithSearchResults = urls.concat(
                        urlsFromSearchResults,
                    );
                    const urlSet = new Set(urlsWithSearchResults);

                    urls = Array.from(urlSet);

                    console.log("urls after filtering: ", urls.length);

                    displaySearchResults(urls);
                }

                displaySearchResults(urls);
            }

            function moveToNextUrl(url) {
                currentUrlIndex++;

                displaySearchResults(urls);
            }

            function addUrlToFinalList(url) {
                finalUrls.push(url);
                currentUrlIndex++;

                displaySearchResults(urls);
            }

            function displaySearchResults(urls) {
                if (currentUrlIndex >= urls.length) {
                    const searchResultsDiv =
                        document.getElementById("search-results");
                    searchResultsDiv.innerHTML = `
                     <div class="text-center py-8">
                       <p class="text-muted-foreground mb-4">No more URLs to display.</p>
                       <p class="text-sm text-muted-foreground">You've reviewed all ${urls.length} search results.</p>
                     </div>
                 `;
                } else {
                    const currentUrl = urls[currentUrlIndex];

                    const searchResultsDiv =
                        document.getElementById("search-results");

                    // Extract domain for display
                    const urlObj = new URL(currentUrl);
                    const domain = urlObj.hostname;

                    searchResultsDiv.innerHTML = `
            <div class="max-w-4xl mx-auto">
              <!-- Header -->
              <div class="text-center mb-6">
                <div class="text-sm text-muted-foreground mb-2">
                  Result ${currentUrlIndex + 1} of ${urls.length}
                </div>
                <div class="w-full bg-secondary rounded-full h-2 mb-4">
                  <div class="bg-primary h-2 rounded-full transition-all duration-300" style="width: ${((currentUrlIndex + 1) / urls.length) * 100}%"></div>
                </div>
              </div>

              <!-- URL Card -->
              <div class="bg-card border border-border rounded-lg p-6 shadow-sm mb-6">
                <h2 class="text-xl font-medium mb-3 text-primary hover:underline cursor-pointer">
                  <a href="${currentUrl}" target="_blank">${currentUrl}</a>
                </h2>

                <div class="text-sm text-muted-foreground mb-4 font-mono">
                  ${domain}
                </div>

                <div class="text-xs text-muted-foreground border-t border-border pt-3">
                  Click to open in new tab
                </div>
              </div>

              <!-- Action Buttons -->
              <div class="flex gap-4 justify-center mb-6">
                <button onclick="moveToNextUrl('${currentUrl}')" class="px-6 py-3 bg-secondary text-secondary-foreground rounded-lg hover:bg-secondary/80 transition-colors">
                  Skip
                </button>
                <button onclick="addUrlToFinalList('${currentUrl}')" class="px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors">
                  Add to List
                </button>
              </div>

              <!-- Preview iframe -->
              <div class="bg-card border border-border rounded-lg overflow-hidden">
                <iframe src="${currentUrl}" loading="lazy" width="100%" height="500px" class="w-full"></iframe>
              </div>
            </div>
          `;
                }
            }

            async function searchForPrompt(searchTerm) {
                const options = {
                    method: "POST",
                    headers: {
                        accept: "application/json",
                        "content-type": "application/json",
                    },
                    body: JSON.stringify({
                        query: searchTerm,
                        excludeDomains: EXCLUDED_DOMAINS,
                    }),
                };

                const rawSearchResults = await fetch(
                    "http://localhost:8081/exa/search",
                    options,
                );

                const searchResults = await rawSearchResults.json();

                const searchResultUrls = searchResults.results.map(
                    (result) => result.url,
                );

                return searchResultUrls;
            }

            async function uploadUrlsToReadwise(tag, apiKey) {
                const readwiseStatusParagraph = document.getElementById(
                    "readwise-upload-status",
                );

                readwiseStatusParagraph.innerHTML = `<p class="text-muted-foreground">Uploading ${finalUrls.length} URLs to Readwise...</p>`;

                for (const url of finalUrls) {
                    const response = await uploadUrlToReadwiseWithRetry(
                        url,
                        tag,
                        apiKey,
                    );
                }

                readwiseStatusParagraph.innerHTML = `<p class="text-green-600">Uploaded ${finalUrls.length} URLs to Readwise!</p>`;
            }

            async function uploadUrlToReadwiseWithRetry(
                url,
                tag,
                apiKey,
                retries = 0,
            ) {
                try {
                    const response = await fetch(
                        "https://readwise.io/api/v3/save/",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                Authorization: `Token ${apiKey}`,
                            },
                            body: JSON.stringify({
                                url,
                                tags: tag ? [tag] : null,
                                location: "later",
                            }),
                        },
                    );

                    const data = await response.json();

                    if ("detail" in data && data.detail.includes("throttled")) {
                        throw new Error(`throttled on retry #${retries}...`);
                    }

                    return data;
                } catch (error) {
                    console.log("backing off to retry...", error);
                    if (retries < MAX_RETRIES) {
                        await new Promise((resolve) =>
                            setTimeout(resolve, INITIAL_BACKOFF),
                        );
                        return uploadUrlToReadwiseWithRetry(
                            url,
                            tag,
                            apiKey,
                            retries + 1,
                        );
                    }

                    throw new Error(`Max retries reached (${MAX_RETRIES})`);
                }
            }
        </script>
    </head>
    <body class="min-h-screen bg-background text-foreground">
        <div class="container mx-auto px-4 py-8 max-w-4xl">
            <!-- Main Header -->
            <div class="text-center mb-12">
                <h1 class="text-3xl font-semibold mb-2">
                    Research Link Discovery
                </h1>
                <p class="text-muted-foreground">
                    Generate search queries and review links one at a time
                </p>
            </div>

            <!-- Prompt Generation Section -->
            <div class="bg-card border border-border rounded-lg p-6 mb-8">
                <h2 class="text-xl font-medium mb-4">
                    1. Generate Search Prompts
                </h2>
                <div class="flex gap-3 mb-4">
                    <input
                        type="text"
                        id="prompt-input"
                        placeholder="Enter your research topic..."
                        class="flex-1 px-4 py-3 bg-input-background border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20"
                    />
                    <button
                        onclick="fetchAndDisplayPrompts(document.getElementById('prompt-input').value)"
                        class="px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors whitespace-nowrap"
                    >
                        Generate Prompts
                    </button>
                </div>

                <div id="prompt-generation-container">
                    <p class="text-muted-foreground text-center py-4">
                        Enter a topic above to generate search prompts
                    </p>
                </div>
            </div>

            <!-- Search Setup Section -->
            <div
                id="search-setup"
                class="bg-card border border-border rounded-lg p-6 mb-8"
            >
                <h2 class="text-xl font-medium mb-4">2. Search for Links</h2>
                <div class="flex gap-3">
                    <button
                        onclick="findAndDisplaySearchResults()"
                        class="px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors whitespace-nowrap"
                    >
                        Start Search
                    </button>
                </div>
            </div>

            <!-- Search Results Section -->
            <div class="mb-8">
                <h2 class="text-xl font-medium mb-6 text-center">
                    3. Review Search Results
                </h2>
                <div id="search-results">
                    <div class="text-center py-8">
                        <p class="text-muted-foreground">
                            Search results will appear here after you start the
                            search
                        </p>
                    </div>
                </div>
            </div>

            <!-- Readwise Upload Section -->
            <div
                id="readwise-upload"
                class="bg-card border border-border rounded-lg p-6"
            >
                <h2 class="text-xl font-medium mb-4">4. Save to Readwise</h2>
                <div class="space-y-3">
                    <div class="flex gap-3">
                        <input
                            type="text"
                            id="readwise-tag"
                            placeholder="Readwise tag (optional)"
                            class="flex-1 px-4 py-3 bg-input-background border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20"
                        />
                        <input
                            type="text"
                            id="readwise-api-key"
                            placeholder="Readwise API key"
                            class="flex-1 px-4 py-3 bg-input-background border border-border rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/20"
                        />
                    </div>

                    <div id="readwise-upload-status" class="text-center py-2">
                        <span class="text-sm text-muted-foreground"
                            >0 URLs saved to your list</span
                        >
                    </div>

                    <button
                        onclick="uploadUrlsToReadwise(document.getElementById('readwise-tag').value, document.getElementById('readwise-api-key').value)"
                        class="w-full px-6 py-3 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90 transition-colors"
                    >
                        Upload URLs to Readwise
                    </button>
                </div>
            </div>
        </div>
    </body>
</html>
